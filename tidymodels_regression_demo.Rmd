---
title: "tidymodels_regression_demo"
author: "WY"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
source('etl.R')
source('utils.R')
source('mod_board.R')
init_db(do=FALSE) # when first time using it, the do parameter should be changed to TRUE as below 
# init_db(do =TRUE)
```

# 1. Introduction
```{r,cache=TRUE}
get_train() |> skimr::skim()

```

show the Premium Amount distribution
```{r}
get_train() |>select(truth=Premium.Amount)|>
  #mutate(truth=log1p(truth))|>
  ggplot(aes(x=truth)) +
  geom_histogram(bins = 100, fill = "blue", color = "black") +
  labs(title = 'Premium Amount distribution plot with log1p',x='Premium Amount')+
  scale_x_continuous(trans = "log1p", breaks = c(0, 100,250,500,1000, 2000, 4000, 6000) 
                     #, labels = c(0, 1, 2, 5, 10) 
                     )+
  theme_classic()
```


# 2.Regression Model improve step by step
## 2.1 frame work


## 2.2models
### -1). V0 init- guest 1102.545
```{r}

get_vmod_v0 <- function(){
  
  avg_value <- 
    get_sample()|>
    summarize(avg_value=mean(`Premium.Amount`))|>
    pull(avg_value)
  
  df <- get_train() |>
    select(truth='Premium.Amount')|>
    mutate(estimate=avg_value)
  
  rcp <- 
    recipes::recipe(truth ~ estimate, data=df)
  
  vmod <- 
    get_fit_wf(rcp,data = df,name='interception 1102.545')
  return(vmod)
}
vmod_v0 <- get_vmod_v0()
```


### -2). v0.1 linear regression
```{r}
get_vmod_v0.1 <- function() {
  
  df<- get_train()|>
    select_if(is.numeric)|>
    rename(truth='Premium.Amount')|>
    collect()
  
  rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_rm(all_nominal())|>
    step_rm(id)
  
  vmod<- get_fit_wf(rcp,data = df,name='all numeric predictor')
  
  return(vmod)

}

vmod_v0.1 <- get_vmod_v0.1()

```
### -3). v0.2 start to use reciep

```{r}

get_vmod_v0.2 <- function(nrows=Inf){
  df <- 
    get_train()|>collect()

 
  rcp <-
    recipe(`Premium.Amount`~ `Age` +
          `Gender`+
          `Annual.Income`+
          `Marital.Status`+
          `Number.of.Dependents`+
          `Education.Level`+
          `Occupation`+
          `Insurance.Duration`+
          `Policy.Type`+
          `Previous.Claims`+
          `Vehicle.Age`+
          `Credit.Score`+
          `Insurance.Duration`+
          `Policy.Start.Date`+
          `Customer.Feedback`+
          `Smoking.Status`+
          `Exercise.Frequency`+
          `Property.Type`,data=df) |>
   step_dummy(all_nominal_predictors())

  vmod<- get_fit_wf(rcp,data = df,name='dummy_nominal')

  return (vmod)
  
}

vmod_v0.2 <- get_vmod_v0.2()
# TODO something wrong v0.1 result is exact as v0.2
```


## 2.3 vetiver
## version model

```{r}

show_model_permformance() %>% 
  mutate(id=fct_reorder(id,desc(.estimate))) %>%
  ggplot(aes(x=id,xend=id,y = 1.12, yend=.estimate,fill=id)) +
  geom_segment(size=7,color='blue')+
  geom_text(aes(x = id, y = .estimate, label = .estimate), 
            hjust = -0.2, vjust = 0.5, size = 5, color = "red") +
  #geom_hline(yintercept = .estimate) +
  scale_y_continuous(limits=c(1.12,1.2),
                     #breaks= seq(0.8, 1.2,by = 0.1)
                     )+
  labs (title = 'model performance board',
        color=NULL) +
  coord_flip()+
  theme_gray()
  
  
  
```
