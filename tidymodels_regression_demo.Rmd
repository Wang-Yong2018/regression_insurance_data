---
title: "tidymodels_regression_demo"
author: "WY"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(tidymodels)
library(textrecipes)
source('etl.R')
source('utils.R')
source('mod_board.R')
init_db(do=FALSE) # when first time using it, the do parameter should be changed to TRUE as below 
# init_db(do =TRUE)
```

# 1. Introduction
```{r,cache=TRUE}
get_train() |> skimr::skim()

```

show the Premium Amount distribution
```{r}
get_train() |>select(truth=Premium.Amount)|>
  #mutate(truth=log1p(truth))|>
  ggplot(aes(x=truth)) +
  geom_histogram(bins = 100, fill = "blue", color = "black") +
  labs(title = 'Premium Amount distribution plot with log1p',x='Premium Amount')+
  scale_x_continuous(trans = "log1p", breaks = c(0, 100,250,500,1000, 2000, 4000, 6000) 
                     #, labels = c(0, 1, 2, 5, 10) 
                     )+
  theme_classic()
```


# 2.Regression Model improve step by step
## 2.1 frame work


## 2.2models
### -0). V0 init- guest 1102.545
```{r}

get_vmod_v0 <- function(){
  
  avg_value <- 
    get_sample()|>
    summarize(avg_value=mean(`Premium.Amount`))|>
    pull(avg_value)
  
  df <- get_train() |>
    select(truth='Premium.Amount')|>
    mutate(estimate=avg_value)|>
    collect()
  
  rcp <- 
    recipes::recipe(truth ~ estimate, data=df)
  
    # Get the call stack
  
  current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
  vmod <- 
    get_fit_wf(rcp,
               data = df,
               name= current_function_name,
               description='interception 1102.545')
  return(vmod)
}
 vmod_v0 <- get_vmod_v0()
```


### -1). v0.1 linear regression
```{r}
get_vmod_v0.1 <- function() {
  
  df<- get_train()|>
    select_if(is.numeric)|>
    rename(truth='Premium.Amount')|>
    collect()
  
  rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_rm(all_nominal())|>
    step_impute_median(all_numeric_predictors())|>
    step_rm(id)|>
    step_pca(num_comp=50)
  
  
  current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
  vmod <- 
    get_fit_wf(rcp,
               data = df,
               name= current_function_name,
               description='all numeric predictor')
  return(vmod)

}

# vmod_v0.1 <- get_vmod_v0.1()
```

### -2). v0.2 start to use reciep
```{r}

get_vmod_v0.2 <- function(nrows=Inf){
   df<- 
     get_train()|>
     select(all_of(get_colname_by_type('numeric')))|>
    select(-id)|>
    rename(truth='Premium.Amount')|>
    collect()
  
  rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_impute_median(all_numeric_predictors())|>
    step_rm(all_nominal())|>
    step_pca(num_comp=50)
  
    current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
  vmod <- 
    get_fit_wf(rcp,
               data = df,
               name= current_function_name,
               description='fillna to all numeric predictor')
  return(vmod)

}

vmod_v0.2 <- get_vmod_v0.2()

```

### -3). v0.3 start to use recipe

```{r}

get_vmod_v0.3 <- function(nrows=Inf){
  df<- 
    get_train()|>
    select(all_of(c(get_colname_by_type('numeric'),get_colname_by_type('datetime'))))|>
    rename(truth='Premium.Amount')|>
    select(-id)|>
    collect()
  
  rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_date(`Policy.Start.Date`, features = c("dow", "month", "year")) |>
    step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_rm(`Policy.Start.Date`)|>
    step_impute_median(all_numeric_predictors())|>
    step_rm(all_nominal())|>
    step_pca(num_comp=50)
  

    current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
    vmod <- 
      get_fit_wf(rcp,
                 data = df,
                 name= current_function_name,
                 description='fillna numeric + date feature')
    return(vmod)
  
}
vmod_v0.3 <- get_vmod_v0.3()


```

### -5 v0.5 
```{r}

get_vmod_v0.5 <- function(nrows=Inf){
  df<- 
    get_train()|>
    rename(truth='Premium.Amount')|>
    select(-id)|>
    collect()
  
  rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_date(`Policy.Start.Date`, features = c("dow", "month", "year")) |>
    #step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_rm(`Policy.Start.Date`)|>
    step_impute_median(all_numeric_predictors())|>
    step_unknown(all_nominal_predictors()) |>
    step_pca(num_comp=50)
  
  current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
    vmod <- 
      get_fit_wf(rcp,
                 data = df,
                 name= current_function_name,
                 description='fillna numeric + date feature+ nominal_dummy_fillmod')
    return(vmod)
  
  
}
# vmod_v0.5 <- get_vmod_v0.5()

```



### -6 v0.6 - manuall change year to dummy 
```{r}

get_vmod_v0.6 <- function(nrows=Inf){
  df<- 
    get_train()|>
    select(-id)|>
    rename(truth='Premium.Amount',
           date = `Policy.Start.Date`)|>
    collect()
  
  rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_date(date, features = c("dow", "month","year")) |>
    step_mutate(date_year = as_factor(date_year)) |>
    step_rm(date)|>
    #step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_impute_median(all_numeric_predictors())|>
    step_unknown(all_nominal_predictors()) |>
    step_pca(num_comp=50)
  
  
  current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
    vmod <- 
      get_fit_wf(rcp,
                 data = df,
                 name= current_function_name,
                 description='v0.6 fillna numeric + date feature+year nominal_dummy_fillmod')
    return(vmod)
  
}
# vmod_v0.6 <- get_vmod_v0.6()
```

### -7 v0.7 - log1p trans income and claims
```{r}

get_vmod_v0.7 <- function(nrows=Inf){
  df<- 
    get_train()|>
    select(-id)|>
    rename(truth='Premium.Amount',
           date = `Policy.Start.Date`)|>
    collect()
  
   rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_date(date, features = c("dow", "month","year")) |>
    step_rm(date)|>
    #step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_impute_median(all_numeric_predictors())|>
    step_unknown(all_nominal_predictors()) |>
    step_mutate(date_year = as_factor(date_year),
               Annual.Income=log1p(Annual.Income),
               #Previous.Claims=as_factor(Previous.Claims),
               #Insurance.Duration=as_factor(Insurance.Duration)
               ) |>
    step_nzv()|>
    step_pca(num_comp=50)
  
  
  current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
    vmod <- 
      get_fit_wf(rcp,
                 data = df,
                 name= current_function_name,
                 description='v0.7 mutate income')
    return(vmod)
  
}
vmod_v0.7 <- get_vmod_v0.7()
```
### -8 v0.8 - log1p trans premium amount
```{r}

get_vmod_v0.8 <- function(nrows=Inf){
  df<- 
    get_train()|>
    select(-id)|>
    rename(truth='Premium.Amount',
           date = `Policy.Start.Date`)|>
    #mutate(truth=log1p(truth))|>
    collect()
  
   rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_log(truth,offset=1) |>
    step_date(date, features = c("dow", "month","year")) |>
    step_rm(date)|>
    #step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_impute_median(all_numeric_predictors())|>
    step_unknown(all_nominal_predictors()) |>
    step_mutate(
      date_year = as_factor(date_year),
      Annual.Income=log1p(Annual.Income),
               ) |>
    step_nzv()|>
    step_pca(num_comp=50)
  
  
  current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
    vmod <- 
      get_fit_wf(rcp,
                 data = df,
                 name= current_function_name,
                 description='v0.8. log1p trans premium amount based on v0.7',
                 is_log1py = TRUE,
                 return_wf = TRUE)
    return(vmod)
  
}
vmod_v0.8 <- get_vmod_v0.8()

```
### -9 v0.9 - add seconds features as the dataset was generated by deeplearning. It is weired.
```{r}

get_vmod_v0.9 <- function(nrows=Inf){
  df<- 
    get_train()|>
    select(-id)|>
    rename(truth='Premium.Amount',
           date = `Policy.Start.Date`)|>
    #mutate(truth=log1p(truth))|>
    collect()
  
   rcp <- 
    recipes::recipe(truth ~.,df)|>
    step_log(truth,offset=1) |>
    step_date(date, features = c("dow", "month","year")) |>
    step_time(date, features= c('second'))|>
    step_rm(date)|>
    #step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_impute_median(all_numeric_predictors())|>
    step_unknown(all_nominal_predictors()) |>
    step_mutate(
      date_year = as_factor(date_year),
      Annual.Income=log1p(Annual.Income),
               ) |>
    step_nzv()|>
    step_pca(num_comp=50)
  
  
  current_function_name <-
    sys.calls() |>
    as.character()|> 
    gsub('()','',x=_,fixed=T)
  
    vmod <- 
      get_fit_wf(rcp,
                 data = df,
                 name= current_function_name,
                 description='v0.9. add seconds feature' ,
                 is_log1py = TRUE,
                 return_wf = TRUE)
    return(vmod)
  
}
vmod_v0.9 <- get_vmod_v0.9()

```
### -v0.10 - cut some numeric into group
```{r}

get_vmod_v0.10 <- function(nrows = Inf) {
  df <-
    get_train() |>
    rename(truth = 'Premium.Amount', date = `Policy.Start.Date`) |>
    #mutate(truth=log1p(truth))|>
    collect()
  income_pct <- get_train() |> pull(Annual.Income) |> quantile(
    x = _,
    probs = seq(0, 1, 0.2),
    na.rm = TRUE,
    include.lowest = T
  )
  age_pct <- get_train() |> pull(Age) |> quantile(
    x = _,
    probs = seq(0, 1, 0.2),
    na.rm = TRUE,
    include.lowest = T
  )
  date_pct <- get_train()|>pull(Policy.Start.Date)|> quantile(
    x=_, 
    probs=seq(0,1,0.05),
    na.rm = TRUE,
    include.lowest = T
    )
  Credit_pct <- get_train()|>pull(Credit.Score)|> quantile(
    x=_, 
    probs=seq(0,1,0.1),
    na.rm = TRUE,
    include.lowest = T
    )
  Health_pct <- get_train()|>pull(Health.Score)|> quantile(
    x=_, 
    probs=seq(0,1,0.1),
    na.rm = TRUE,
    include.lowest = T
    )
  rcp <-
    recipes::recipe(truth ~ ., df) |>
    update_role(id, new_role='ID')|>
    step_log(truth, offset = 1) |>
    step_date(date, features = c("dow", "month", "year")) |>
    #    step_time(date, features= c('second'))|>
    #step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_impute_median(all_numeric_predictors()) |>
    step_unknown(all_nominal_predictors()) |>
    step_mutate(
      Annual.Income_cut = cut(Annual.Income, 
                              breaks = income_pct,
                              include_outside_range = TRUE ),
      Credit.Score_cut = cut(Credit.Score, 
                    breaks = Credit_pct, 
                    include_outside_range = TRUE), 
      Health.Score_cut = cut(Health.Score, 
                    breaks = Health_pct, 
                    include_outside_range = TRUE), 
      Age_cut = cut(Age, 
                    breaks = age_pct, 
                    include_outside_range = TRUE), 
      Age_cut = cut(Age, 
                    breaks = age_pct, 
                    include_outside_range = TRUE), 
      date_cut = cut(date,
                     breaks = date_pct,
                     include_outside_range = TRUE) ) |>
    step_mutate(
      date_year = as_factor(date_year),
      Insurance.Duration = as_factor(Insurance.Duration),
      Previous.Claims = as_factor(Previous.Claims),
      Number.of.Dependents = as_factor(Number.of.Dependents)
      # Annual.Income=log1p(Annual.Income),
    ) |>
    step_nzv() |>
    step_rm(date) |>
    step_pca(num_comp = 50)
  baked_data <- rcp|> prep() |>bake(df)
  
  current_function_name <-
    sys.calls() |>
    as.character() |>
    gsub('()', '', x = _, fixed = T)
  
  vmod <-
    get_fit_wf(
      rcp,
      data = df,
      name = current_function_name,
      description = 'v0.10. add cut age, income',
      is_log1py = TRUE,
      return_wf = TRUE
    )
  return(vmod)
  
}
vmod_v0.10 <- get_vmod_v0.10()

```
### -v0.11 - cut some numeric into group and convert the group as factor
```{r}

get_vmod_v0.11 <- function(nrows = Inf) {
  df <-
    get_train() |>
    select(-id) |>
    rename(truth = 'Premium.Amount', date = `Policy.Start.Date`) |>
    #mutate(truth=log1p(truth))|>
    collect()
  
  income_pct <- get_train() |> pull(Annual.Income) |> quantile(
    x = _,
    probs = seq(0, 1, 0.2),
    na.rm = TRUE,
    include.lowest = T
  )
  age_pct <- get_train() |> pull(Age) |> quantile(
    x = _,
    probs = seq(0, 1, 0.2),
    na.rm = TRUE,
    include.lowest = T
  )
  date_pct <- get_train()|>pull(Policy.Start.Date)|> quantile(
    x=_, 
    probs=seq(0,1,0.05),
    na.rm = TRUE,
    include.lowest = T
    )
  Credit_pct <- get_train()|>pull(Credit.Score)|> quantile(
    x=_, 
    probs=seq(0,1,0.1),
    na.rm = TRUE,
    include.lowest = T
    )
  Health_pct <- get_train()|>pull(Health.Score)|> quantile(
    x=_, 
    probs=seq(0,1,0.1),
    na.rm = TRUE,
    include.lowest = T
    )
  
  rcp <-
    recipes::recipe(truth ~ ., df) |>
    #update_role(id, new_role='ID')|>
    step_log(truth, offset = 1) |>
    step_date(date, features = c("dow", "month", "year")) |>
    #    step_time(date, features= c('second'))|>
    #step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_impute_median(all_numeric_predictors()) |>
    step_unknown(all_nominal_predictors()) |>
    step_mutate(
      Annual.Income_cut = cut(Annual.Income, 
                              breaks = income_pct,
                              include_outside_range = TRUE ),
      Credit.Score_cut = cut(Credit.Score, 
                    breaks = Credit_pct, 
                    include_outside_range = TRUE), 
      Health.Score_cut = cut(Health.Score, 
                    breaks = Health_pct, 
                    include_outside_range = TRUE), 
      Age_cut = cut(Age, 
                    breaks = age_pct, 
                    include_outside_range = TRUE), 
      date_cut = cut(date,
                     breaks = date_pct,
                     include_outside_range = TRUE) ) |>
    step_mutate(
      Annual.Income_cut = as.factor(Annual.Income_cut),
      Credit.Score_cut = as.factor(Credit.Score_cut),
      Health.Score_cut = as.factor(Health.Score_cut),
      Age_cut = as.factor(Age_cut),
      date_cut = as.factor(date_cut),
      date_year = as_factor(date_year),
      Insurance.Duration = as_factor(Insurance.Duration),
      Previous.Claims = as_factor(Previous.Claims),
      Number.of.Dependents = as_factor(Number.of.Dependents)
    ) |>
    step_rm(date) |>
    #step_dummy_hash(all_nominal_predictors(),num_terms=16)|>
    step_nzv() #|>
    #step_pca(all_predictors(),num_comp = 50)
  
  #rcp|>prep()|> print()
 
  current_function_name <-
    sys.calls() |>
    as.character() |>
    gsub('()', '', x = _, fixed = T)
  
  vmod <-
    get_fit_wf(
      rcp,
      data = df,
      name = current_function_name,
      description = 'v0.11. add cut age, income',
      is_log1py = TRUE,
      return_wf = TRUE
    )
  return(vmod)
  
}
vmod_v0.11 <- get_vmod_v0.11()

```

### eda rpart tree plot 
```{r}
library(tidymodels)
library(rpart.plot)
library(vip)
tree_spec <- 
  decision_tree(cost_complexity = 0.001, 
                min_n =100,
                tree_depth=8) |>
  set_engine("rpart",model=TRUE)

reg_tree_spec <- 
  tree_spec |> 
  set_mode("regression")

set.seed(1234)

 df <-
    get_train() |>
    select(-id) |>
    rename(truth = 'Premium.Amount', date = `Policy.Start.Date`) |>
    #mutate(truth=log1p(truth))|>
    collect()
  income_pct <- get_train() |> pull(Annual.Income) |> quantile(
    x = _,
    probs = seq(0, 1, 0.2),
    na.rm = TRUE,
    include.lowest = T
  )
  age_pct <- get_train() |> pull(Age) |> quantile(
    x = _,
    probs = seq(0, 1, 0.2),
    na.rm = TRUE,
    include.lowest = T
  )
  date_pct <- get_train()|>pull(Policy.Start.Date)|> quantile(
    x=_, 
    probs=seq(0,1,0.05),
    na.rm = TRUE,
    include.lowest = T
    )
  rcp <-
    recipes::recipe(truth ~ ., df) |>
    step_log(truth, offset = 1) |>
    step_date(date, features = c("dow", "month", "year")) |>
    #    step_time(date, features= c('second'))|>
    #step_holiday(`Policy.Start.Date`, holidays = timeDate::listHolidays()) |>
    step_impute_median(all_numeric_predictors()) |>
    step_unknown(all_nominal_predictors()) |>
    step_mutate(
      Annual.Income_cut = cut(Annual.Income, 
                              breaks = income_pct,
                              include_outside_range = TRUE ),
      Age_cut = cut(Age, 
                    breaks = age_pct, 
                    include_outside_range = TRUE), 
      date_cut = cut(date,
                     breaks = date_pct,
                     include_outside_range = TRUE) ) |>
    step_mutate(
      date_year = as_factor(date_year),
      Insurance.Duration = as_factor(Insurance.Duration),
      Previous.Claims = as_factor(Previous.Claims),
      Number.of.Dependents = as_factor(Number.of.Dependents)
      # Annual.Income=log1p(Annual.Income),
    ) |>
    step_nzv() |>
    step_rm(date) |>
    step_pca(num_comp = 50)|>
     prep()|>bake(new_data=df)
  
  
reg_tree_fit <- fit(reg_tree_spec, truth ~ ., rcp)
reg_tree_fit %>%
  extract_fit_engine() %>%
  rpart.plot()

```

```{r}
#TODO know why some insurance premium amount was so low.
```
### - v0.11
```{r}
# TODO build user group identity and find if they buy some insurance.
# TODO 20 price buying pattern related to time
# TODO the dataset was generated by deep learning process. find the pattern
# TODO publish notebook
# TODO use decision tree or forest to eda 
# TODO add null count per row variable.
```

## 2.3 vetiver
## version model

```{r}
show_model_permformance() %>% 
  mutate(id=fct_reorder(id,desc(.estimate))) %>%
  ggplot(aes(x=id,xend=id,y = 1.05, yend=.estimate,fill=id)) +
  geom_segment(size=7,color='blue')+
  geom_text(aes(x = id, y = .estimate, label = .estimate), 
            hjust = -0.2, vjust = 0.5, size = 5, color = "red") +
  #geom_hline(yintercept = .estimate) +
  scale_y_continuous(limits=c(1.05,1.2),
                     #breaks= seq(0.8, 1.2,by = 0.1)
                     )+
  labs (title = 'model performance board',
        color=NULL) +
  coord_flip()+
  theme_gray()
  
```


## 2.4 plot residual

## plot residual
```{r}

 
  get_mods_log_residual(mod_name_pattern = 'vmod_v0.1')|>
  ggplot(aes(x = value, fill = name,color=name)) +
  geom_density(alpha = 0.1) +
  labs(title = "Overlaid Density Plots", x = "Values", y = "Density") +
  theme_minimal()
  
```

```{r}
get_train()|>
  select(id,date=`Policy.Start.Date`) |>
  cbind(get_mods_log_residual(mod_name_pattern = 'v0.8')) |>
  group_by(year(date)) |>
  summarize(across(starts_with('value'),
                   list(mean = ~ mean(.x, na.rm = TRUE),
                        sum = ~sum(.x,na.rm = T)
                        ), 
                   .names = "{.col}.{.fn}")
            ) |>
  round(2)


```

```{r}
year_log_resi <- 
  get_train()|>select(id,date=`Policy.Start.Date`) |>
  cbind(get_mods_log_residual(mod_name_pattern = 'v0.8')|>filter(grepl('v0.8',name))) |> mutate(year_id = as_factor(year(date))) 

year_log_resi|>
  select(value, year=year_id)|>
  ggplot(aes(x = value, group=year,color = year)) +
  geom_density(alpha = 0.3)+
    labs(title = "Overlaid Density Plots", x = "Values", y = "Density") +
  theme_minimal()

```
# 3. predict and submit
by use trained work flow to predict and submit
```{r}
best_mod <- vmod_v0.8
save_submit <-function(best_mod ){
  
  submit_file_name <- 'output/sample_submit.csv_v0.1.gz'
  
  test_data <-  
    get_test()|>
    rename(date=Policy.Start.Date)

  pred <- best_mod|>
    predict(test_data)|>
    pull(.pred)
  
  get_sample() |>
    select(id) |>
    mutate(`Premium Amount` = pred)|>
    fwrite(submit_file_name,compress='gzip')
}

save_submit(vmod_v0.8)
```

